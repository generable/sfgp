---
title: "Assessing the effect of a treatment with SFGP"
author: "Juho Timonen"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Assessing the effect of a treatment with SFGP}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
---


# Setup

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(ggplot2)
library(sfgp)
```

# Simulated data

```{r sim, fig.width = 7.2, fig.height = 4}
set.seed(10)
dat <- sfsim()
head(dat)
plt1 <- ggplot(dat, aes(x = t, y = f, group = id, color = arm)) +
  geom_line()
plt2 <- ggplot(dat, aes(x = t, y = y, group = id, color = arm)) +
  geom_line() +
  geom_point()
plt1
plt2
```

# Fitting the model

```{r fit, fig.width = 7.2, fig.height = 3.3}
model <- TSModel$new(y ~ sf(t, id | arm) + gp(t) + gp(t, arm))
dat <- add_sff_input(dat, model)
fit_post <- model$fit(dat, chains = 1, refresh = 1000)
fit_prior <- model$fit(dat, chains = 1, refresh = 1000, prior_only = TRUE)
```

# Treatment effect

## Trajectories for new subjects

We now assume that we have $G_{\text{arm}} \geq 2$ treatment arms, and
a model of the form

$$
f(\mathbf{x})= \sum_{j=1}^J f^{(j)}(\mathbf{x})
$$
where $J \geq 2$, and

$$
\begin{align}
f^{(1)}(\mathbf{x}) &= f^{\text{BAS}} \left(\text{id} \mid \mathbf{c}_{0}\right) \\
f^{(2)}(\mathbf{x}) &= f^{\text{log-SF}} \left(t, \text{id}, \text{arm} \mid \mathbf{k}_{g}, \mathbf{k}_{s}\right)
\end{align},
$$
and the possible remaining terms $f^{(j)}$, $j=1, \ldots, J$ do not depend on 
$\text{id}$. We can divide the covariates as
$\mathbf{x} = \left\{t, \text{id}, \text{arm}, \mathbf{x}'\right\}$,
where $\mathbf{x}'$ are the possible remaining covariates. In the following,
we assume that $\mathbf{x}' = \emptyset$, i.e. there are no other covariates.

## Generating the trajectories

For each treatment arm $a \in \left\{1, \ldots, G_{\text{arm}}\right \}$,
we generate trajectories $f_a(t^*)$, $t \in T$ that represent
new imaginary subjects from arm $a$. 

The trajectories are generated by drawing
the components so that any individual-specific parameters are drawn from
prior and posterior draws are used for the remaining parameters. Finally, 
for each trajectory, a constant is added
so that they each trajectory has $f_a(0) = 0$.


## Exponentiated trajectories

Before computing trajectory metrics, the trajectories are exponentiated as 
$g_a(t^*) = \exp\left(f_a(t^*)\right)$, meaning that $g_a(0) = 1$. Therefore,
the trajectories describe growth of tumor relative to the baseline size. 

```{r te, fig.width = 7.2, fig.height = 3.3}
# "New" subjects
te <- treatment_effect(fit_post, fit_prior, time_var = "t", group_var = "arm")

te$traj$plot()
```

## Depth of response

### Definition
For a given trajectory $g = \exp(f)$ on time interval interval $[0, T]$, 
the depth of response is defined as

$$
\text{DoR}_{T}\left(g\right) = \frac{g(0) - \min_{t \in [0, T]} g(t)}{g(0)}
$$

### Example
```{r dor}
# Depth of response
dor <- te$traj$dor(group_var = "arm")
plot_dor(te)
dor
```

## Duration of response

### Definition
For a given trajectory $g$ on time interval interval $[0, T]$,
the duration of response is defined as

$$
\text{DuR}_{T}\left(g\right) = t^{\text{end}}_T(g) - t^{\text{start}}_T(g)
$$
where the start time of response $t^{\text{start}}_T(g)$ is the smallest 
$t \in [0, T]$ that satisfies 
$$
g(t) \leq 0.7 \cdot g(0)
$$
and the response end time $t^{\text{end}}_T(g)$ is 
the smallest $t \in \left(t^{\text{start}}_T(g), T\right]$ that satisfies
$$
g(t) \geq 1.2 \cdot \min_{t' \in [0, t)} g(t').
$$
In other words, the start time is the first time
point where the trajectory is at least $30\%$ lower than the start value,
and end point is the first time point after the start point where the 
trajectory is at least
$20\%$ higher than the minimum until that time point. If the start point does 
not exist, then $\text{DuR}_{T}\left(g\right) = 0$. If the end point does not
exist but start point does, then 
$$
\text{DuR}_{T}\left(g\right) = T - t^{\text{start}}_T(g).
$$

### TTB120

An alternative metric is time to $120\%$ of baseline (@johnson2020). It is
defined as
$$
\text{TTB120}_T \left( g \right) =  \arg \min_{t \in (0, T)} \left\{g(t) \geq 1.2 \cdot g(0) \right\}.
$$
and $T$ if the condition is not satisfied on the interval $(0, T)$.

### Example
```{r dur}
# Duration of response
plot_dur(te)
plot_dur(te, metric = "TTB120")
summarize_dur(te)
```

We can compute the metrics only for the trajectories for which the 
response exists like so

```{r durfilt}
# Duration of response, for those new subjects that are responding
summarize_dur(te, only_responding = TRUE)
```

## Distribution of the difference to control

By giving the `control_group_name` argument, we can plot the difference
to control arm.

```{r diff_control}
ca <- "1"
plot_dor(te, halfeye = TRUE, control_group_name = ca)
plot_dur(te, halfeye = TRUE, control_group_name = ca)
```

## Probability of difference to control

This is how we can calculate 

$$
P(x_a > a_b \mid x_a \neq x_b)
$$
where $x_a, x_b$ are the values of some metric for arms $a$ and $b$, respectively.

```{r p_diff_control}
d1 <- dor_diff(te$depth, control_group_name = ca, gt = T)
print(d1)
d2 <- dur_diff(te$duration, control_group_name = ca, gt = T)
print(d2)
```

## Invariance of metrics under trajectory scaling

Assume that $f^*(t) = f(t) + \log C$. Then 

$$
g^*(t) = \exp(f^*(t)) = \exp(f(t) + \log C) = g(t)\cdot C
$$
and
$$
\begin{align}
\text{DoR}_{T}\left(g^*\right) &= \frac{g(0)\cdot C - \min_{t \in [0, T]} g(t) \cdot C}{g(0) \cdot C}\\
&= \frac{g(0) - \min_{t \in [0, T]} g(t)}{g(0)} \\
&= \text{DoR}_{T}\left(g\right) 
\end{align}
$$

Furthermore, the inequalities in the definition of response duration and TTB120
are equivalent for $g$ and $g^*$, which can be seen by multiplying both sides 
by $C$. The response depth, duration, and TTB120 of a trajectory are 
therefore not affected by multiplying by a constant, 
which is done when we move the trajectories to start from 1.

## Using group-level mean trajectories

In this method, the trajectories are generated otherwise the same as above,
but we generate each trajectory draw using
the group-level means of the parameters $k_s$, $k_g$
(i.e. set $\log(z) = 0$, see the SF term
parametrization in the \code{math} vignette).

```{r te2, fig.width = 7.2, fig.height = 3.3}
# Group-level mean trajectories
te2 <- treatment_effect(fit_post, fit_prior,
  time_var = "t", group_var = "arm",
  method = "group_est"
)

te2$traj$plot()

# Depth of response
dor <- te2$traj$dor(group_var = "arm")
plot_dor(te2)
dor

# Duration of response
plot_dur(te2)
plot_dur(te2, metric = "TTB120")
summarize_dur(te2)
```

## Using an alternative definition of depth

In this method, we define actual expected measurement times in `t_depth`,
and then compute the depth based on a "best response" which is the minimum
tumor size after baseline, at these expected measurement times.

So for a given trajectory $g = \exp(f)$, baseline time point $t_0$, and 
a vector of post-baseline time points $\textbf{t}$, the best response depth is

$$
\text{BR}_{t_0, \textbf{t}}\left(g\right) = \frac{g(t_0) - \min_{t \in \textbf{t}} g(t_0)}{g(t_0)}
$$
which will be negative for trajectories that never go below baseline.

```{r te3, fig.width = 7.2, fig.height = 3.3}
t_pred <- seq(0, 46, by = 1 * 7) # expected measurement every week
te3 <- treatment_effect(fit_post, fit_prior,
  time_var = "t", group_var = "arm",
  br = TRUE, t_pred = t_pred
)

te3$traj$plot()

# Depth of response
dor <- te3$traj$dor(group_var = "arm")
plot_dor(te3)
dor
```

# References



