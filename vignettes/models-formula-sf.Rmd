---
title: "SF model with different formulas for ks parameter"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{SF model with different formulas for ks parameter}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ggplot2)
library(sfgp)
```

# Utilities

```{r}
get_hier_offset_draws <- function(fit, term_sfx) {
  list(
    log_z = fit$draws(paste0("log_z_offset_", term_sfx)),
    log_mu = fit$draws(paste0("log_mu_offset_", term_sfx)),
    log_sigma = fit$draws(paste0("log_sigma_offset_", term_sfx))
  )
}


plot_fit <- function(pred, data) {
  pred$function_draws()$plot(group_by = "id", facet_by = "id") + geom_point(data, mapping = aes(x = t, y = y, group = id), inherit.aes = FALSE)
}

# Creates data with auc
create_data <- function(...) {
  N <- 12
  dat <- sfsim(
    n1 = N, n2 = N, n3 = N, kg_sd = 0.2, ks_sd = 0.2, t_sd = 0,
    sigma = 0.2, ...
  )
  dat$auc <- 400 * dat$x
  dat <- dat[dat$arm == 2, ]
  dat
}

get_C_draws <- function(fit) {
  list(
    log_C_kg = fit$draws("log_C_kg"),
    log_C_ks = fit$draws("log_C_ks")
  )
}
```

# Models

```{r models, fig.width = 7.2, fig.height = 4.3}
form1 <- y ~ sff(t | ks ~ offset(id_ks | arm_ks) + gp(auc_ks), kg ~ offset(id_kg | arm_kg))
form2 <- y ~ sff(t | ks ~ offset(id_ks | arm_ks) + emax(auc_ks, arm_ks), kg ~ offset(id_kg | arm_kg))
form1b <- y ~ sff(t | ks ~ gp(auc_ks), kg ~ offset(id_kg | arm_kg))
form2b <- y ~ sff(t | ks ~ emax(auc_ks, arm_ks), kg ~ offset(id_kg | arm_kg))
prior_bas <- list(prior_intercept = "normal(4,2)")
m1 <- TSModel$new(form1b, prior_baseline = prior_bas)
m2 <- TSModel$new(form2b, prior_baseline = prior_bas)
```

# Experiment 1 (no effect)

```{r dat1, fig.width = 7.2, fig.height = 4}
ttt <- seq(0.01, 48, by = 6)
dat <- create_data(times = ttt)

# Plot the true effect of x on ks
ggplot(dat, aes(x = x, y = f_x_ks)) +
  geom_line()

# Plot data
ggplot(dat, aes(x = t, y = y, group = id, color = arm)) +
  geom_line()
```

```{r fit1, fig.width = 7.2, fig.height = 7}
run_experiment <- function(data) {
  dat1 <- add_sff_input(data, m1)
  dat2 <- add_sff_input(data, m2)
  f1 <- m1$fit(dat1, chains = 1, refresh = 200, skip_transform = "f_log_sff_t")
  f2 <- m2$fit(dat2, chains = 1, refresh = 200, skip_transform = "f_log_sff_t")

  message("printing draws for f1")
  print(get_C_draws(f1))

  message("printing draws for f2")
  print(get_C_draws(f2))

  f_gp <- f1$create_functiondraws(c("auc", "auc_ks"), "f_gp_auc_ks")
  f_emax <- f2$create_functiondraws(c("auc", "auc_ks"), "f_emax_auc_ksXarm_ks")
  ks1 <- f1$create_functiondraws(c("auc", "auc_ks"), "ks")
  ks2 <- f2$create_functiondraws(c("auc", "auc_ks"), "ks")
  plots <- list(
    f_gp$plot() + theme(legend.position = "none"),
    f_emax$plot() + theme(legend.position = "none"),
    ks1$log()$plot() + theme(legend.position = "none"),
    ks2$log()$plot() + theme(legend.position = "none")
  )
  list(
    plt = ggpubr::ggarrange(plotlist = plots, labels = "auto", ncol = 2, nrow = 2),
    f1 = f1,
    f2 = f2
  )
}

res1 <- run_experiment(dat)
res1$f1$plot()
res1$f2$plot()
print(res1$f1$draws("alpha_auc_ks"))
print(res1$f2$draws("Emax"))
print(res1$f2$draws("log_ED50"))
print(res1$f2$draws("gamma"))
res1$plt
```

# Experiment 2 (with effect)

```{r dat2, fig.width = 7.2, fig.height = 4}
dat <- create_data(times = ttt, x_effect = 0.7)

# Plot the true effect of x on ks
ggplot(dat, aes(x = x, y = f_x_ks)) +
  geom_line()

# Plot data
ggplot(dat, aes(x = t, y = y, group = id, color = arm)) +
  geom_line()
ggplot(dat, aes(x = t, y = y, group = id, color = f_x_ks)) +
  geom_line(lwd = 1) +
  facet_wrap(. ~ arm) +
  scale_color_continuous(type = "viridis")
```

```{r fit2, fig.width = 7.2, fig.height = 7}
res2 <- run_experiment(dat)
res2$f1$plot()
res2$f2$plot()
print(res2$f1$draws("alpha_auc_ks"))
print(res2$f2$draws("Emax"))
print(res2$f2$draws("log_ED50"))
print(res2$f2$draws("gamma"))
res2$plt
```

# Used Stan code

## Model with GP

```{r}
cat(m1$create_stancode())
```

## Model with sigmoid (Emax)

```{r}
cat(m2$create_stancode())
```
